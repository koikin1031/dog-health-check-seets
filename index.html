<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>わが家の愛犬 健康チェックシート</title>
  <meta name="theme-color" content="#4ba3ff" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f3f4f6;
    }
    header {
      background: #4ba3ff;
      color: #fff;
      padding: 10px 16px;
      text-align: center;
      font-weight: bold;
    }
    main {
      padding: 10px 8px 40px;
      max-width: 900px;
      margin: 0 auto;
    }
    section {
      background: #fff;
      margin-bottom: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 10px;
    }
    section h2 {
      margin: 0 0 8px;
      font-size: 16px;
      border-left: 4px solid #4ba3ff;
      padding-left: 6px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 6px 8px;
      align-items: center;
      font-size: 14px;
    }
    label {
      font-size: 13px;
    }
    input, textarea, select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #f9fafb;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .row2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    .row3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    .sub-title {
      font-weight: bold;
      margin: 6px 0 4px;
      font-size: 13px;
      color: #374151;
      border-bottom: 1px dashed #e5e7eb;
    }
    .buttons {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(243,244,246,0.96);
      padding: 4px 8px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      justify-content: center;
      border-top: 1px solid #e5e7eb;
    }
    .buttons-inner {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .primary {
      background: #4ba3ff;
      color: #fff;
    }
    .secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .small-btn {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
    }
    small {
      font-size: 11px;
      color: #6b7280;
    }
    #lastSaved {
      text-align: center;
      font-size: 11px;
      color: #6b7280;
    }
    .illness-row {
      margin-bottom: 4px;
    }
    .illness-row .remove-ill-btn {
      margin-top: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
    }
    .photo-preview img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 6px;
      display: block;
    }
  </style>
</head>
<body>
<header>わが家の愛犬 健康チェックシート</header>

<main>
  <!-- ペット選択 -->
  <section>
    <h2>ペットの選択</h2>
    <div class="row2">
      <div>
        <label for="currentPet">ペット</label>
        <select id="currentPet" name="currentPet"></select>
      </div>
      <div style="display:flex;align-items:flex-end;justify-content:flex-end;">
        <button type="button" id="addPetBtn" class="secondary small-btn">＋ 新しいペット</button>
      </div>
    </div>
    <small>ペットを切り替えて、1つのアプリで複数のペットを管理できます。</small>
  </section>

  <!-- 基本情報 -->
  <section>
    <h2>基本情報</h2>
    <div class="grid">
      <label for="petName">愛称 <span style="color:#ef4444;font-size:11px;">※必須</span></label>
      <input id="petName" name="petName" type="text" />

      <label for="petSex">性別</label>
      <select id="petSex" name="petSex">
        <option value="">選択してください</option>
        <option value="オス">オス</option>
        <option value="メス">メス</option>
      </select>

      <label for="breed">種類（犬種など）</label>
      <input id="breed" name="breed" type="text" />

      <label for="color">毛色</label>
      <input id="color" name="color" type="text" />

      <label for="birthday">生年月日 <span style="color:#ef4444;font-size:11px;">※必須</span></label>
      <input id="birthday" name="birthday" type="date" />

      <label for="adoptDate">飼育年月日</label>
      <input id="adoptDate" name="adoptDate" type="date" />

      <label for="height">体高(cm)</label>
      <input id="height" name="height" type="number" step="0.1" inputmode="decimal" />

      <label for="length">体長(cm)</label>
      <input id="length" name="length" type="number" step="0.1" inputmode="decimal" />

      <label for="weight">体重(kg)</label>
      <input id="weight" name="weight" type="number" step="0.1" inputmode="decimal" />

      <label for="shop">ペットショップ／元の飼主名</label>
      <input id="shop" name="shop" type="text" />

      <label for="regNo">登録番号</label>
      <input id="regNo" name="regNo" type="text" />

      <label for="tel">電話</label>
      <input id="tel" name="tel" type="tel" />

      <label for="address">住所</label>
      <textarea id="address" name="address"></textarea>
    </div>
    <small>※PHOTO欄は、このアプリ上に写真を1枚保存する想定です。</small>
  </section>

  <!-- PHOTO -->
  <section>
    <h2>PHOTO</h2>
    <div>
      <label for="photoFile">愛犬の写真（1枚）</label>
      <input id="photoFile" name="photoFile" type="file" accept="image/*" />
      <!-- 実際に保存するのはこのhiddenに入ったデータURL -->
      <input id="photoData" name="photoData" type="hidden" />
      <div id="photoPreviewWrapper" class="photo-preview">
        <small>写真を選ぶと下にプレビュー表示されます（この端末のブラウザ内だけに保存されます）。</small>
        <img id="photoPreview" alt="愛犬の写真プレビュー" style="display:none;">
      </div>
    </div>
    <small>※写真はこの端末のブラウザにのみ保存され、サーバーには送信されません。</small>
  </section>

  <!-- ワクチン -->
  <section>
    <h2>ジステンバー・ワクチン接種日</h2>
    <div class="sub-title">ワクチン</div>
    <div class="row2">
      <div>
        <label for="vaccine1">1回目</label>
        <input id="vaccine1" name="vaccine1" type="date" />
      </div>
      <div>
        <label for="vaccine2">2回目</label>
        <input id="vaccine2" name="vaccine2" type="date" />
      </div>
    </div>

    <div class="sub-title">狂犬病予防注射接種日</div>
    <div class="row2">
      <div>
        <label for="rabies1">1回目</label>
        <input id="rabies1" name="rabies1" type="date" />
      </div>
      <div>
        <label for="rabies2">2回目</label>
        <input id="rabies2" name="rabies2" type="date" />
      </div>
    </div>
  </section>

  <!-- フィラリア検査 -->
  <section>
    <h2>フィラリア検査</h2>
    <div class="row3">
      <div>
        <label for="filariaDate1">検査日①</label>
        <input id="filariaDate1" name="filariaDate1" type="date" />
      </div>
      <div>
        <label for="filariaResult1">結果</label>
        <input id="filariaResult1" name="filariaResult1" type="text" placeholder="陰性／陽性など" />
      </div>
      <div>
        <label for="filariaDrug1">薬品名</label>
        <input id="filariaDrug1" name="filariaDrug1" type="text" />
      </div>

      <div>
        <label for="filariaDate2">検査日②</label>
        <input id="filariaDate2" name="filariaDate2" type="date" />
      </div>
      <div>
        <label for="filariaResult2">結果</label>
        <input id="filariaResult2" name="filariaResult2" type="text" />
      </div>
      <div>
        <label for="filariaDrug2">薬品名</label>
        <input id="filariaDrug2" name="filariaDrug2" type="text" />
      </div>
    </div>
  </section>

  <!-- 検便・駆虫 -->
  <section>
    <h2>検便・駆虫</h2>
    <div class="sub-title">検便</div>
    <div class="row3">
      <div>
        <label for="stoolDate1">検便日①</label>
        <input id="stoolDate1" name="stoolDate1" type="date" />
      </div>
      <div>
        <label for="parasite1">寄生虫名</label>
        <input id="parasite1" name="parasite1" type="text" />
      </div>
      <div>
        <label for="dewormDrug1">駆虫薬品名</label>
        <input id="dewormDrug1" name="dewormDrug1" type="text" />
      </div>

      <div>
        <label for="stoolDate2">検便日②</label>
        <input id="stoolDate2" name="stoolDate2" type="date" />
      </div>
      <div>
        <label for="parasite2">寄生虫名</label>
        <input id="parasite2" name="parasite2" type="text" />
      </div>
      <div>
        <label for="dewormDrug2">駆虫薬品名</label>
        <input id="dewormDrug2" name="dewormDrug2" type="text" />
      </div>
    </div>
  </section>

  <!-- 病気（可変行リスト） -->
  <section>
    <h2>病気の記録</h2>
    <div id="illnessList"></div>
    <button type="button" id="addIllnessBtn" class="secondary small-btn" style="margin-top:6px;">＋ 行を追加</button>
    <small>※行を追加して、病気ごとに「病気になった日」「治った日」「病名」「費用」を好きなだけ記録できます。</small>
  </section>

  <!-- 備考 -->
  <section>
    <h2>備考欄</h2>
    <textarea id="memo" name="memo" placeholder="気づいたこと・注意点など"></textarea>
  </section>
</main>

<div class="buttons">
  <div id="lastSaved">まだ保存されていません</div>
  <div class="buttons-inner">
    <button class="primary" id="saveBtn">保存</button>
    <button class="secondary" id="clearBtn">全て消す</button>
  </div>
</div>

<script>
  // 新バージョンのストレージキー（旧バージョンからのマイグレーションも考慮）
  const STORAGE_KEY = 'pet-memo-v2';
  const OLD_STORAGE_KEY = 'pet-memo-v1';

  // アプリ全体の状態（複数ペット対応）
  let appState = {
    activePetId: null,
    lastSavedAt: null,
    pets: {}
  };

  function createNewPet() {
    const id = 'pet-' + Date.now() + '-' + Math.random().toString(16).slice(2);
    appState.pets[id] = {
      fields: {},
      illnesses: []
    };
    appState.activePetId = id;
    return id;
  }

  // 病気欄の1行を作成（病気になった日＋治った日）
  function createIllnessRow(illness = {}) {
    const container = document.getElementById('illnessList');
    const wrapper = document.createElement('div');
    wrapper.className = 'illness-row';

    wrapper.innerHTML = `
      <div class="row3">
        <div>
          <label>病気になった日</label>
          <input type="date" data-ill-field="startDate" />
          <label style="margin-top:4px;display:block;">治った日</label>
          <input type="date" data-ill-field="endDate" />
        </div>
        <div>
          <label>病名</label>
          <input type="text" data-ill-field="name" />
        </div>
        <div>
          <label>費用(円)</label>
          <input type="number" inputmode="decimal" data-ill-field="cost" />
          <button type="button" class="secondary small-btn remove-ill-btn">削除</button>
        </div>
      </div>
    `;

    const inputs = wrapper.querySelectorAll('input');
    inputs.forEach(input => {
      const field = input.dataset.illField;
      if (field === 'startDate') {
        if (illness.startDate) input.value = illness.startDate;
        else if (illness.date) input.value = illness.date; // 旧データ互換
      }
      if (field === 'endDate' && illness.endDate) input.value = illness.endDate;
      if (field === 'name' && illness.name) input.value = illness.name;
      if (field === 'cost' && illness.cost) input.value = illness.cost;
    });

    const removeBtn = wrapper.querySelector('.remove-ill-btn');
    removeBtn.addEventListener('click', () => {
      wrapper.remove();
    });

    container.appendChild(wrapper);
  }

  function renderIllnessList(illnesses) {
    const container = document.getElementById('illnessList');
    container.innerHTML = '';
    if (illnesses && illnesses.length > 0) {
      illnesses.forEach(ill => createIllnessRow(ill));
    } else {
      // 最低1行は表示しておく
      createIllnessRow();
    }
  }

  function collectIllnessesFromDOM() {
    const list = [];
    document.querySelectorAll('.illness-row').forEach(row => {
      const startDateEl = row.querySelector('[data-ill-field="startDate"]');
      const endDateEl = row.querySelector('[data-ill-field="endDate"]');
      const nameEl = row.querySelector('[data-ill-field="name"]');
      const costEl = row.querySelector('[data-ill-field="cost"]');

      const startDate = startDateEl ? startDateEl.value : '';
      const endDate = endDateEl ? endDateEl.value : '';
      const name = nameEl ? nameEl.value : '';
      const cost = costEl ? costEl.value : '';

      // 全部空白の行は保存しない
      if (startDate || endDate || name || cost) {
        list.push({ startDate, endDate, name, cost });
      }
    });
    return list;
  }

  // 病気以外の入力要素を取得（data-ill-field を持たないもの）
  function getStaticInputs() {
    return Array.from(document.querySelectorAll('input, textarea, select')).filter(
      el => !el.dataset.illField && el.id !== 'currentPet' && el.id !== 'photoFile'
    );
  }

  // PHOTOプレビュー更新（hiddenのphotoDataから反映）
  function updatePhotoPreviewFromHidden() {
    const data = document.getElementById('photoData')?.value || '';
    const img = document.getElementById('photoPreview');
    if (!img) return;
    if (data) {
      img.src = data;
      img.style.display = 'block';
    } else {
      img.src = '';
      img.style.display = 'none';
    }
  }

  // 現在フォームの内容を appState のアクティブなペットに反映（ローカルストレージにはまだ書かない）
  function saveCurrentFormToState() {
    const petId = appState.activePetId;
    if (!petId) return;

    const fields = {};
    getStaticInputs().forEach(el => {
      if (el.id) {
        fields[el.id] = el.value;
      }
    });

    const illnesses = collectIllnessesFromDOM();
    appState.pets[petId] = {
      fields,
      illnesses
    };
  }

  // 指定ペットIDのデータをフォームに反映
  function fillFormFromPet(petId) {
    const pet = appState.pets[petId] || { fields: {}, illnesses: [] };
    const fields = pet.fields || {};
    getStaticInputs().forEach(el => {
      el.value = fields[el.id] !== undefined ? fields[el.id] : '';
    });
    renderIllnessList(pet.illnesses || []);
    updatePhotoPreviewFromHidden();
  }

  // ペット選択セレクトの中身を再描画
  function renderPetSelector() {
    const select = document.getElementById('currentPet');
    if (!select) return;

    select.innerHTML = '';
    const petIds = Object.keys(appState.pets);

    if (petIds.length === 0) {
      const id = createNewPet();
      petIds.push(id);
    }

    petIds.forEach((id, index) => {
      const opt = document.createElement('option');
      opt.value = id;
      const fields = appState.pets[id].fields || {};
      const name = fields.petName || `ペット${index + 1}`;
      const birthday = fields.birthday || '';
      opt.textContent = birthday ? `${name}（${birthday}）` : name;
      select.appendChild(opt);
    });

    if (!appState.activePetId || !appState.pets[appState.activePetId]) {
      appState.activePetId = petIds[0];
    }
    select.value = appState.activePetId;
  }

  function formatDateTimeForDisplay(iso) {
    if (!iso) return 'まだ保存されていません';
    const d = new Date(iso);
    const y = d.getFullYear();
    const m = ('0' + (d.getMonth() + 1)).slice(-2);
    const day = ('0' + d.getDate()).slice(-2);
    const hh = ('0' + d.getHours()).slice(-2);
    const mm = ('0' + d.getMinutes()).slice(-2);
    return `最終保存：${y}/${m}/${day} ${hh}:${mm}`;
  }

  function updateLastSavedLabel() {
    const label = document.getElementById('lastSaved');
    if (!label) return;
    label.textContent = formatDateTimeForDisplay(appState.lastSavedAt);
  }

  // ローカルストレージからデータ読み込み（旧フォーマットも考慮）
  function loadData() {
    let raw = localStorage.getItem(STORAGE_KEY);
    let fromOld = false;

    if (!raw) {
      const oldRaw = localStorage.getItem(OLD_STORAGE_KEY);
      if (oldRaw) {
        raw = oldRaw;
        fromOld = true;
      }
    }

    appState = {
      activePetId: null,
      lastSavedAt: null,
      pets: {}
    };

    if (raw) {
      try {
        const saved = JSON.parse(raw);

        if (!fromOld && saved && saved.pets) {
          // すでに v2 形式
          appState = saved;
        } else {
          // v1 形式 → 1匹分として取り込む
          const id = createNewPet();
          const fields = saved || {};
          const illnesses = [];

          // 旧バージョンの illDate1〜3, illName1〜3, illCost1〜3 を動的リストに変換
          for (let i = 1; i <= 3; i++) {
            const date = fields[`illDate${i}`];
            const name = fields[`illName${i}`];
            const cost = fields[`illCost${i}`];
            if (date || name || cost) {
              illnesses.push({
                startDate: date || '',
                endDate: '',
                name: name || '',
                cost: cost || ''
              });
            }
            delete fields[`illDate${i}`];
            delete fields[`illName${i}`];
            delete fields[`illCost${i}`];
          }

          appState.pets[appState.activePetId] = {
            fields,
            illnesses
          };
        }
      } catch (e) {
        console.warn('データ読み込み失敗', e);
        appState = {
          activePetId: null,
          lastSavedAt: null,
          pets: {}
        };
        createNewPet();
      }
    } else {
      // 何もないときは空の1匹を作る
      createNewPet();
    }

    renderPetSelector();
    fillFormFromPet(appState.activePetId);
    updateLastSavedLabel();
  }

  // 保存ボタン（バリデーション＋ローカルストレージ保存）
  function saveData() {
    const petNameEl = document.getElementById('petName');
    const birthdayEl = document.getElementById('birthday');
    const petName = petNameEl.value.trim();
    const birthday = birthdayEl.value.trim();

    // 必須チェック
    if (!petName || !birthday) {
      alert('「愛称」と「生年月日」は必須です。入力してから保存してください。');
      // 必須項目が分かりやすいようにフォーカス
      if (!petName) {
        petNameEl.focus();
      } else if (!birthday) {
        birthdayEl.focus();
      }
      return;
    }

    // まず現在フォームを状態に反映
    saveCurrentFormToState();

    // 保存したタイミングの時刻を記録
    const now = new Date();
    appState.lastSavedAt = now.toISOString();

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
      updateLastSavedLabel();
      // ペット名や誕生日が変わったかもしれないのでセレクトを更新
      renderPetSelector();
      alert('保存しました（この端末のブラウザ内）');
    } catch (e) {
      console.error(e);
      alert('保存に失敗しました（容量オーバーの可能性）');
    }
  }

  // 全削除ボタン
  function clearData() {
    if (!confirm('全ての入力内容と保存データを削除します。よろしいですか？')) return;
    localStorage.removeItem(STORAGE_KEY);
    appState = {
      activePetId: null,
      lastSavedAt: null,
      pets: {}
    };
    createNewPet();
    renderPetSelector();
    fillFormFromPet(appState.activePetId);
    updateLastSavedLabel();
  }

  // PHOTOファイル選択時の処理
  function handlePhotoChange(e) {
    const file = e.target.files && e.target.files[0];
    const hidden = document.getElementById('photoData');
    if (!hidden) return;

    if (!file) {
      hidden.value = '';
      updatePhotoPreviewFromHidden();
      return;
    }

    if (!file.type.startsWith('image/')) {
      alert('画像ファイルを選択してください。');
      e.target.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      hidden.value = reader.result || '';
      updatePhotoPreviewFromHidden();
    };
    reader.readAsDataURL(file);
  }

  window.addEventListener('load', () => {
    loadData();

    // ペット選択変更でペット切り替え
    document.getElementById('currentPet').addEventListener('change', (e) => {
      // 今の入力を状態に反映
      saveCurrentFormToState();
      // アクティブペット切り替え
      appState.activePetId = e.target.value;
      // 新しいペットの内容をフォームに反映
      fillFormFromPet(appState.activePetId);
    });

    // 新しいペット追加
    document.getElementById('addPetBtn').addEventListener('click', () => {
      // 今のペットの内容を一度状態に保存
      saveCurrentFormToState();
      // 新規ペット作成
      createNewPet();
      renderPetSelector();
      fillFormFromPet(appState.activePetId);
    });

    // 病気行追加
    document.getElementById('addIllnessBtn').addEventListener('click', () => {
      createIllnessRow();
    });

    // 保存ボタン
    document.getElementById('saveBtn').addEventListener('click', saveData);
    // 全削除ボタン
    document.getElementById('clearBtn').addEventListener('click', clearData);

    // PHOTOファイル入力
    const photoInput = document.getElementById('photoFile');
    if (photoInput) {
      photoInput.addEventListener('change', handlePhotoChange);
    }

    // PWA用 Service Worker 登録
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    }
  });
</script>
</body>
</html>
